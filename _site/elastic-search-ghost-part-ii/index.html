<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A layout example that shows off a blog page with a list of posts.">

    <title>ElasticSearch + Ghost: Part II</title>

    <!-- <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/pure.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/grids-responsive.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/typography.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/blog.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/styles.css"> -->

    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/common_all.css">    
  </head>

  <body>
    <div id="layout" class="pure-g">
      <div class="sidebar pure-u-1 pure-u-md-1-4">
        <div class="header">
          <h1 class="brand-title">The Shiny Coin</h1>
          <h2 class="brand-tagline">A blog about the modern web.</h2>

          <nav class="nav">
            <ul class="nav-list">
              <li class="nav-item">
                
                  <a class="pure-button" href="/">&larr; Back Home</a>
                
              </li>
              <!-- <li class="nav-item">
                <a class="pure-button" href="http://yuilibrary.com">YUI Library</a>
              </li> -->
            </ul>
          </nav>
        </div>
      </div>

      <div class="content  pure-u-1 pure-u-md-3-4">
        <article class="post">
  <header class="post-header">
    <!-- <img class="post-avatar" alt="Biswarup Chakravarty&#x27;s avatar" height="48" width="48" data-email="biswarup.chakravarty@gmail.com"> -->
    <h1 class="post-title"><a href="/elastic-search-ghost-part-ii" class="post-title-link">ElasticSearch + Ghost: Part II</a></h1>
    <p class="post-meta">
      By <a href="" class="post-author">Biswarup Chakravarty</a> on <time datetime="">13 March 2015</time>
      under 
        <a class="post-tag post-tag-index-1" href="#">Elastic Search</a>
      
        <a class="post-tag post-tag-index-2" href="#">Ghost Blog</a>
      
        <a class="post-tag post-tag-index-3" href="#">JavaScript</a>
      
   </p>
   <div class="social-buttons-container">
  <ul class="social-buttons cf">
    <li>
      <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Socialite.js" data-url="/elastic-search-ghost-part-ii" rel="nofollow" target="_blank"><span class="vhidden"><!-- Share on Twitter --></span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=/elastic-search-ghost-part-ii" class="socialite googleplus-one" data-href="/elastic-search-ghost-part-ii" rel="nofollow" target="_blank"><span class="vhidden"><!-- Share on Google --></span></a>
    </li>
    <li>
      <a href="http://www.facebook.com/sharer.php?u=http://www.socialitejs.com&amp;t=Socialite.js" class="socialite facebook-like" data-href="/elastic-search-ghost-part-ii" data-send="false" data-layout="button_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden"><!-- Share on Facebook --></span></a>
    </li>
    <li></li>
    <!-- <li>
    <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=/elastic-search-ghost-part-ii&amp;title=Socialite.js" class="socialite linkedin-share" data-url="/elastic-search-ghost-part-ii" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
    </li>
    <li>
    <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=/elastic-search-ghost-part-ii&amp;title=Socialite.js" class="socialite linkedin-share" data-url="/elastic-search-ghost-part-ii" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
    </li> -->
  </ul>
</div>
   <hr>
 </header>
 <section class="post-description">
  <p>This is the second part of the series explaining how to get up and running with elastic search and integrate it into your ( self hosted ) Ghost blog. Make sure you’ve read the <a href="/elastic-search-ghost-part-i/">first part!</a></p>

<h2 id="introduction">Introduction</h2>

<p>In the previous part, we set up Elastic Search on our AWS instance. We went over the basics of indices and types, and saw how data is stored, retrieved, searched and deleted in Elastic Search.</p>

<p>In this part, we are going to modify the Ghost blogging server itself and create a way for us to get the content of all the posts out programmatically. We will do this to be able to index (save) the posts into Elastic Search. Instead of doing all the indexing manually, we will create a simple Node.js program that will do it for us.</p>

<h2 id="modifying-the-ghost-blogging-server">Modifying the Ghost Blogging Server</h2>

<p>Alright, we are going to add 2 additional APIs to the Ghost web-server:</p>

<ol>
  <li>An API that will simply return a list of all the posts in JSON format. This will be used to feed data into Elastic Search. Let’s call this the <code>all_posts</code> API.</li>
  <li>An API that will be used to actually perform the searching. This will primarily be a proxy API and simply connect the client (browser) with Elastic Search. Let’s call this the <code>search</code> API.</li>
</ol>

<p>The <code>all_posts</code> API will only be used internally, i.e. only from the machine that hosts the Ghost blog. Nothing special needs to be done as AWS does not allow access on all ports by default (IIRC it only allows on access on ports 22, 80 and 443).</p>

<h3 id="routes-and-controllers">Routes and Controllers</h3>

<h4 id="routes">Routes</h4>

<p>Most server side web application frameworks like Rails, Express and even client side MVC frameworks like Backbone.js, Ember.js have a concept of routes. Routes are like rules that dictate what should happen when particular URLs (or URL patterns) are hit. Generally routes specify the URL pattern (via regex) and the controller/method that is supposed to process the request.</p>

<p>For the Ghost server, the routes reside under <code>core/server/routes</code>. There are 3 routes files:</p>

<dl>
<dt>`admin.js`</dt>
<dd>This contains the routes for the admin side of things (signin, signup, reset/change password, creating content, the editor, blog settings). Effectively all URLs that reside under `/ghost/` are listed here.</dd>
<dt>`api.js`</dt>
<dd>This contains the routes for all the URLs that are used by the Ghost blog API to work with posts, settings, users, tags, notifications and the import/export of your data.</dd>
<dt>`frontend.js`</dt>
<dd>Aha! This is where the routes for the RSS feed and the routes for the Ghost blog are mentioned (there are only 3 main routes: the `/rss/` URL, the URLs for the posts and the home page route.</dd>
</dl>

<h4 id="controllers">Controllers</h4>

<p>Controllers are tasked with actually processing the request and generating the response that is send to the browser. The controller generally interacts with the models and then renders one or more views to be presented to the user.</p>

<p>Ghost keeps the controllers under <code>core/server/controllers/</code> directory. There are 2 controllers:</p>

<dl>
<dt>`admin.js`</dt>
<dd>This controller deals with all the tasks that are performed by the blog administrator</dd>
<dt>`frontend.js`</dt>
<dd>This is the controller that handles the URLs defined in the routes file `/core/server/routes/frontend.js` i.e. showing the homepage, showing the posts and the RSS feed.</dd>
</dl>

<h3 id="the-all-posts-api">The <code>All Posts</code> API</h3>

<p>As mentioned earlier The <code>all_posts</code> API will be used to fetch all our posts in the JSON format. There are 2 steps to adding a new API.</p>

<h4 id="creating-the-route">1. Creating the Route</h4>

<p>Let’s register a new route for our API. SSH into your server and navigate to <code>/var/www/core/server/routes/</code> and open <code>frontend.js</code>. This is what the file should look like:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">frontend</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../controllers/frontend&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/*jslint regexp: true */</span>
  <span class="c1">// ### Frontend routes</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/rss/&#39;</span><span class="p">,</span> <span class="nx">frontend</span><span class="p">.</span><span class="nx">rss</span><span class="p">);</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/rss/:page/&#39;</span><span class="p">,</span> <span class="nx">frontend</span><span class="p">.</span><span class="nx">rss</span><span class="p">);</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/page/:page/&#39;</span><span class="p">,</span> <span class="nx">frontend</span><span class="p">.</span><span class="nx">homepage</span><span class="p">);</span>
  <span class="c1">// Only capture the :slug part of the URL</span>
  <span class="c1">// This regex will always have two capturing groups,</span>
  <span class="c1">// one for date, and one for the slug.</span>
  <span class="c1">// Examples:</span>
  <span class="c1">//  Given `/plain-slug/` the req.params would be [undefined, &#39;plain-slug&#39;]</span>
  <span class="c1">//  Given `/2012/12/24/plain-slug/` the req.params would be [&#39;2012/12/24/&#39;, &#39;plain-slug&#39;]</span>
  <span class="c1">//  Given `/plain-slug/edit/` the req.params would be [undefined, &#39;plain-slug&#39;, &#39;edit&#39;]</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sr">/^\\/</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]{</span><span class="mi">4</span><span class="p">}</span><span class="err">\\</span><span class="o">/</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]{</span><span class="mi">2</span><span class="p">}</span><span class="err">\\</span><span class="o">/</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]{</span><span class="mi">2</span><span class="p">}</span><span class="err">\\</span><span class="o">/</span><span class="p">)</span><span class="o">?</span><span class="p">([</span><span class="o">^</span><span class="err">\\</span><span class="o">/</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="err">\\</span><span class="o">/</span><span class="nx">$</span><span class="o">/</span><span class="p">,</span> <span class="nx">frontend</span><span class="p">.</span><span class="nx">single</span><span class="p">);</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sr">/^\\/</span><span class="p">([</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]{</span><span class="mi">4</span><span class="p">}</span><span class="err">\\</span><span class="o">/</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]{</span><span class="mi">2</span><span class="p">}</span><span class="err">\\</span><span class="o">/</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">]{</span><span class="mi">2</span><span class="p">}</span><span class="err">\\</span><span class="o">/</span><span class="p">)</span><span class="o">?</span><span class="p">([</span><span class="o">^</span><span class="err">\\</span><span class="o">/</span><span class="p">.]</span><span class="o">*</span><span class="p">)</span><span class="err">\\</span><span class="o">/</span><span class="nx">edit</span><span class="err">\\</span><span class="o">/</span><span class="nx">$</span><span class="o">/</span><span class="p">,</span> <span class="nx">frontend</span><span class="p">.</span><span class="nx">edit</span><span class="p">);</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">frontend</span><span class="p">.</span><span class="nx">homepage</span><span class="p">);</span></code></pre></div>

<p>The format used to define routes here is <code>server.HTTP_METHOD( REGULAR_EXPRESSION , CONTROLLER_METHOD )</code>.</p>

<p>Lets add our own route:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/all_posts/&#39;</span><span class="p">,</span> <span class="nx">frontend</span><span class="p">.</span><span class="nx">all_posts</span><span class="p">);</span></code></pre></div>

<p><strong>Note:</strong> The frontend controller does not yet contain a definition for the function <code>all_posts</code>. Do not restart your server just yet as the route is not functional yet and the server will not start (you might get an <code>Possibly unhandled Error: .get() requires callback functions but got a [object Undefined]</code> error)</p>

<h4 id="creating-the-route-handler-in-the-controller">2. Creating the Route Handler in the Controller</h4>

<p>Time to define the <code>all_posts</code> function that we mentioned in the routes file. Navigate to <code>/var/www/core/server/controllers/</code> and open up <code>frontend.js</code>. Add in the function to the <code>frontendControllers</code> object, like so:</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">frontendControllers</span> <span class="o">=</span> <span class="p">{</span>

  <span class="c1">// function definitions snipped</span>

  <span class="s2">&quot;all_posts&quot;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">browse</span><span class="p">({</span>
      <span class="nx">page</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">limit</span><span class="o">:</span> <span class="mi">1000</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">posts</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posts</span> <span class="o">||</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;[]&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">posts</span><span class="p">.</span><span class="nx">posts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span>
                <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                    <span class="nx">title</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
                    <span class="nx">content</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">markdown</span><span class="p">,</span>
                    <span class="nx">slug</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">slug</span><span class="p">,</span>
                    <span class="nx">tags</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span> <span class="p">}),</span>
                    <span class="nx">updated_at</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">updated_at</span><span class="p">)</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">output</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span>

  <span class="c1">// function definitions snipped</span>

<span class="p">};</span></code></pre></div>

<p>This function will fetch all your posts (actually the first 1000 posts), extract the title, content and the URL slug from each, and finally return an array containing the extracted posts. An empty array will be returned if nothing’s found.</p>

<p>Restart your Ghost server to test out the new route. Navigate to <code>/all_posts/</code> via your web browser. You should get something like:</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[{</span>
  <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Some thoughts about stuff&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Readymade bitters authentic before they sold out tofu.&quot;</span><span class="p">,</span>
  <span class="nt">&quot;slug&quot;</span><span class="p">:</span> <span class="s2">&quot;some-thoughts-about-stuff&quot;</span>
  <span class="p">},</span> <span class="p">{</span>
  <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;something&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Some blog post!&quot;</span><span class="p">,</span>
  <span class="nt">&quot;slug&quot;</span><span class="p">:</span> <span class="s2">&quot;something&quot;</span>
  <span class="p">},</span> <span class="p">{</span>
  <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Welcome to Ghost&quot;</span><span class="p">,</span>
  <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You&#39;re live! Nice. [[...]] Have fun - and let us know what you think :)&quot;</span><span class="p">,</span>
  <span class="nt">&quot;slug&quot;</span><span class="p">:</span> <span class="s2">&quot;welcome-to-ghost&quot;</span>
  <span class="p">}]</span></code></pre></div>

<p>Pat yourself on the back! You’ve successfully extended the Ghost blogging platform and added new functionality into it!</p>

<h2 id="indexing-posts-into-elasticsearch">Indexing Posts into ElasticSearch</h2>

<p>OK, we’re almost there. Lets create a very basic (and hack-ish) Node.js script that is going to pull data from our <code>all_posts</code> API and dump it into ElasticSearch via the <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/docs-bulk.html">Bulk API</a>.</p>

<h3 id="create-the-mass-indexer-script">Create the Mass Indexer Script</h3>

<p>Create a new file in your home directory called <code>mass_indexer.js</code>.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ~
touch mass_indexer.js</code></pre></div>

<p>We’ll use the <a href="https://github.com/mikeal/request">Request</a> Library to manage our HTTP for us.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">npm install request</code></pre></div>

<p>Now open the <code>mass_indexer.js</code> file for editing</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">vi mass_indexer.js</code></pre></div>

<p>Copy-paste the following code in the file and save+quit vi (<code>:wq!</code>).</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">httpRequest</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">),</span>
  <span class="nx">getMetaForPosts</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">posts</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">requestString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
      <span class="nx">meta</span><span class="p">;</span>
    <span class="nx">posts</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">meta</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">create</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">_index</span><span class="o">:</span> <span class="s2">&quot;posts&quot;</span><span class="p">,</span>
          <span class="nx">_type</span><span class="o">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span>
          <span class="nx">id</span><span class="o">:</span> <span class="o">~~</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">};</span>
      <span class="nx">requestString</span> <span class="o">+=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">meta</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\</span>
<span class="s1">      &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">post</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\</span>
<span class="s1">&#39;</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">requestString</span><span class="p">;</span>
  <span class="p">},</span> <span class="nx">validate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">body</span><span class="p">;</span>
  <span class="p">};</span>

<span class="c1">// callback hell!!</span>
<span class="nx">httpRequest</span><span class="p">({</span>
  <span class="nx">uri</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9200&#39;</span>
  <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">validate</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Elastic Search running, deleting posts index...&quot;</span><span class="p">);</span>
  <span class="nx">httpRequest</span><span class="p">.</span><span class="nx">del</span><span class="p">({</span>
    <span class="nx">uri</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9200/posts/&#39;</span>
  <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">validate</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Deleted index successfully, recreating &#39;posts&#39; index...&quot;</span><span class="p">);</span>
    <span class="nx">httpRequest</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span>
      <span class="nx">uri</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9200/posts/&#39;</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">validate</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Fetching posts...&quot;</span><span class="p">);</span>
      <span class="nx">httpRequest</span><span class="p">({</span>
        <span class="nx">uri</span><span class="o">:</span> <span class="s1">&#39;http://127.0.0.1:2368/all_posts/&#39;</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">validate</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">posts</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">posts</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Could not fetch posts!&quot;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Fetched &quot;</span> <span class="o">+</span> <span class="nx">posts</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; posts, Bulk Indexing posts...&quot;</span><span class="p">);</span>
        <span class="nx">httpRequest</span><span class="p">.</span><span class="nx">post</span><span class="p">({</span>
          <span class="nx">uri</span><span class="o">:</span> <span class="s1">&#39;http://localhost:9200/posts/post/_bulk&#39;</span><span class="p">,</span>
          <span class="nx">body</span><span class="o">:</span> <span class="nx">getMetaForPosts</span><span class="p">(</span><span class="nx">posts</span><span class="p">)</span>
        <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">validate</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">);</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Done indexing&quot;</span><span class="p">)</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p><small>(Yes, this needs to be fixed and yes, it looks like an 8 year old wrote it!)</small></p>

<h3 id="index-all-the-posts">Index All The Posts!</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">node ~/mass_indexer.js</code></pre></div>

<p><strong>Congratulations!</strong></p>

<p>You’ve managed to index all your posts into Elastic Search!</p>

<h2 id="summary">Summary</h2>

<p>In this post, we’ve created a route under <code>/all_posts/</code> and written a controller method to get all our blog posts out of Ghost. We’ve also created a script that will call this API and re-index all of this data into Elastic Search.</p>

<hr />

<h3 id="coming-up">Coming Up</h3>

<p>In the next post, we’ll create another new API in our installation of Ghost that will actually execute searches on Elastic Search and return the results.</p>

<p>We should probably figure out a way to hook in the indexing script into the Ghost server itself so that it automatically gets triggered whenever a blog post is edited or created.</p>

  </section>
</article>

<footer class="post-footer">
  
  <section class="author">
    <h4></h4>
    <p></p>
  </section>
  

  <section class="comments">
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </section>
</footer>
      </div>

    </div>
    <!-- <script type="text/javascript" src="/assets/javascripts/common/md5.js"></script> -->
    <!-- <script type="text/javascript" src="/assets/javascripts/common/init.js"></script> -->

    <!-- <script type="text/javascript" src="/assets/javascripts/common/socialite.min.js"></script> -->

    <script type="text/javascript" src="/assets/javascripts/common/common_all.js"></script>
  </body>
</html>
