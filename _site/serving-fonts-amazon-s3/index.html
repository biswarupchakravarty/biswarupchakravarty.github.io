<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A layout example that shows off a blog page with a list of posts.">

    <title>Serving Fonts From Amazon S3</title>

    <!-- <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/pure.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/grids-responsive.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/typography.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/syntax.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/blog.css">
    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/styles.css"> -->

    <link rel="stylesheet" type="text/css" href="/assets/stylesheets/common/common_all.css">    
  </head>

  <body>
    <div id="layout" class="pure-g">
      <div class="sidebar pure-u-1 pure-u-md-1-4">
        <div class="header">
          <h1 class="brand-title">The Shiny Coin</h1>
          <h2 class="brand-tagline">A blog about the modern web.</h2>

          <nav class="nav">
            <ul class="nav-list">
              <li class="nav-item">
                
                  <a class="pure-button" href="/">&larr; Back Home</a>
                
              </li>
              <!-- <li class="nav-item">
                <a class="pure-button" href="http://yuilibrary.com">YUI Library</a>
              </li> -->
            </ul>
          </nav>
        </div>
      </div>

      <div class="content  pure-u-1 pure-u-md-3-4">
        <article class="post">
  <header class="post-header">
    <!-- <img class="post-avatar" alt="Biswarup Chakravarty&#x27;s avatar" height="48" width="48" data-email="biswarup.chakravarty@gmail.com"> -->
    <h1 class="post-title"><a href="/serving-fonts-amazon-s3" class="post-title-link">Serving Fonts From Amazon S3</a></h1>
    <p class="post-meta">
      By <a href="" class="post-author">Biswarup Chakravarty</a> on <time datetime="">16 March 2015</time>
      under 
        <a class="post-tag post-tag-index-1" href="#">Fonts</a>
      
        <a class="post-tag post-tag-index-2" href="#">Amazon S3</a>
      
        <a class="post-tag post-tag-index-3" href="#">CloudFront</a>
      
        <a class="post-tag post-tag-index-4" href="#">CORS</a>
      
   </p>
   <div class="social-buttons-container">
  <ul class="social-buttons cf">
    <li>
      <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Socialite.js" data-url="/serving-fonts-amazon-s3" rel="nofollow" target="_blank"><span class="vhidden"><!-- Share on Twitter --></span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=/serving-fonts-amazon-s3" class="socialite googleplus-one" data-href="/serving-fonts-amazon-s3" rel="nofollow" target="_blank"><span class="vhidden"><!-- Share on Google --></span></a>
    </li>
    <li>
      <a href="http://www.facebook.com/sharer.php?u=http://www.socialitejs.com&amp;t=Socialite.js" class="socialite facebook-like" data-href="/serving-fonts-amazon-s3" data-send="false" data-layout="button_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden"><!-- Share on Facebook --></span></a>
    </li>
    <li></li>
    <!-- <li>
    <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=/serving-fonts-amazon-s3&amp;title=Socialite.js" class="socialite linkedin-share" data-url="/serving-fonts-amazon-s3" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
    </li>
    <li>
    <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=/serving-fonts-amazon-s3&amp;title=Socialite.js" class="socialite linkedin-share" data-url="/serving-fonts-amazon-s3" data-counter="top" rel="nofollow" target="_blank"><span class="vhidden">Share on LinkedIn</span></a>
    </li> -->
  </ul>
</div>
   <hr>
 </header>
 <section class="post-description">
  <p>A couple of days back we ran into some issues with our externally hosted fonts. Firefox and Chrome both refused to load them in certain cases (I don’t have IE). This post is going to detail how we got past them by serving fonts from Amazon S3 instead of using CouldFront. I’m going to assume the reader is familiar with CORS and how it applies to external files and the <code>@font-face</code> rule.</p>

<p>The font files were hosted on S3 and were being served via CloudFront. We have eot, woff, ttf and svg formats. Firefox was the first to stop serving them for people who did not have the font in their cache. Chrome consistently picked up the files from cache, even in incognito mode.</p>

<p>One thing became clear as soon as I started debugging is that CloudFront caches CORS headers. Some of the <code>OPTIONS</code> requests were working for some people and some were not. In my case, my FF couldn’t fetch the font file but the same FF version was working just fine for the guy sitting right beside me – both of us had cleared the cache from the beginning of time and were using In Private Browsing.</p>

<p>Now the issue was that CloudFront was busting up the cross domain requests. I’d already refreshed the CORS config from the AWS Console but it wasn’t really making any sort of difference, so I decided to serve them via S3 instead.</p>

<p>I set a far future <code>Expires</code> header on all the font files and changed the root font file url in the SCSS file to point to S3 instead of CloudFront and deployed it for some testing.</p>

<p>Boom!</p>

<p>All HTTPS pages were broken. I should have seen this coming as AWS’s S3 SSL Certificate is issued for <code>*.s3.amazonaws.com</code> and our bucket was <code>assets.[snip].com.s3.amazonaws.com</code>. Damn!</p>

<p>So I created another bucket <code>[snip]-fonts</code>, placed all the fonts there, changed their <code>Expires</code> header and changed the root url for fonts to <code>[snip]-fonts.s3.amazonaws.com</code>. Deployed on staging again (hooray for one click deployments!).</p>

<p>It worked. Reliably. On HTTP and HTTPS. Thank God!</p>

<p>If you’re using AWS, I’d suggest you use S3 to host and serve your font files and bypass CloudFront altogether – S3 is was more reliable.</p>

<p>To summarize:</p>

<ul>
  <li>Create a bucket <code>&lt;name&gt;</code> at the root of your S3 and move all your font files into it.</li>
  <li>Set a future <code>Expires</code> header. If you need to burst the cache, just add a query string variable to it ex. <code>[font-url]?_v=1</code>.</li>
  <li>In your <code>@font-face</code> rules, ensure that the protocol is relative ie. <code>//&lt;font-url&gt;</code></li>
</ul>

  </section>
</article>

<footer class="post-footer">
  
  <section class="author">
    <h4></h4>
    <p></p>
  </section>
  

  <section class="comments">
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </section>
</footer>
      </div>

    </div>
    <!-- <script type="text/javascript" src="/assets/javascripts/common/md5.js"></script> -->
    <!-- <script type="text/javascript" src="/assets/javascripts/common/init.js"></script> -->

    <!-- <script type="text/javascript" src="/assets/javascripts/common/socialite.min.js"></script> -->

    <script type="text/javascript" src="/assets/javascripts/common/common_all.js"></script>
  </body>
</html>
